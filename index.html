<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestionCompta CI - Sécurisé Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; }

        /* Écran de connexion */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .auth-card {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; width: 90%; max-width: 400px;
        }
        .auth-card i { color: #1a2980; margin-bottom: 20px; }
        .auth-card input {
            width: 100%; padding: 15px; margin: 20px 0;
            border: 2px solid #ddd; border-radius: 10px; font-size: 1.2rem; text-align: center;
        }

        /* App cachée par défaut */
        #main-app { display: none; padding: 15px; }

        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        header { 
            background: #1a2980; color: white; padding: 20px; 
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; 
        }

        .balance-box h2 { color: #FFD700; font-size: 2.2rem; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; }
        .stat-card { padding: 20px; border-radius: 10px; color: white; display: flex; align-items: center; gap: 15px; }
        .bg-green { background: #27ae60; }
        .bg-red { background: #e74c3c; }

        .section { padding: 20px; border-bottom: 1px solid #eee; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
        
        input, select { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
        
        .btn { 
            padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; 
            font-weight: bold; color: white; display: inline-flex; align-items: center; 
            gap: 8px; justify-content: center; transition: 0.3s;
        }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        
        .btn-save { background: #1a2980; }
        .btn-wa { background: #25D366; }
        .btn-pdf { background: #e74c3c; }
        .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.5); color: white; font-size: 0.9rem; }
        .btn-danger { background: #ff4757; }
        .btn-sync { background: #f39c12; }

        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        
        @media (max-width: 768px) { .charts-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card">
        <i class="fas fa-shield-alt fa-4x"></i>
        <h2 id="auth-title">Connexion</h2>
        <p id="auth-msg">Accès sécurisé GamingCompta CI</p>
        <input type="password" id="password-input" inputmode="numeric" placeholder="Code PIN">
        <button onclick="handleAuth()" class="btn btn-save" style="width: 100%">Ouvrir la session</button>
    </div>
</div>

<div id="main-app">
    <div class="container">
        <header>
            <div class="logo">
                <h1><i class="fas fa-gamepad"></i> GamingCompta CI</h1>
                <p id="current-date" style="opacity: 0.8"></p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="changePIN()" class="btn btn-outline"><i class="fas fa-key"></i> Code</button>
                <button onclick="logout()" class="btn btn-danger"><i class="fas fa-power-off"></i> Quitter</button>
            </div>
        </header>

        <div class="section" style="background: #f8f9fa; display: flex; justify-content: space-between; align-items: center">
            <div class="balance-box">
                <small style="color: #666; font-weight: bold">CAISSE GÉNÉRALE</small>
                <h2 id="total-balance">0 FCFA</h2>
            </div>
            <div style="display: flex; gap: 10px">
                <button onclick="sendWhatsApp()" class="btn btn-wa"><i class="fab fa-whatsapp"></i> WhatsApp Patron</button>
                <button onclick="exportJSON()" class="btn btn-sync"><i class="fas fa-cloud-download-alt"></i> Sauvegarde</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card bg-green">
                <i class="fas fa-plus-circle fa-2x"></i>
                <div><small>Recettes (Jour)</small><h3 id="day-rev">0 F</h3></div>
            </div>
            <div class="stat-card bg-red">
                <i class="fas fa-minus-circle fa-2x"></i>
                <div><small>Dépenses (Jour)</small><h3 id="day-exp">0 F</h3></div>
            </div>
        </div>

        <div class="section">
            <h3>Ajouter une opération</h3>
            <div class="form-row" style="margin-top: 10px;">
                <input type="text" id="desc" placeholder="Ex: Session PS5 N°2">
                <input type="number" id="price" placeholder="Prix">
                <select id="type">
                    <option value="recette">Recette</option>
                    <option value="depense">Dépense</option>
                </select>
                <select id="mode">
                    <option value="Espèces">Espèces</option>
                    <option value="Wave/OM">Mobile Money</option>
                </select>
                <button onclick="addEntry()" class="btn btn-save"><i class="fas fa-check"></i></button>
            </div>
        </div>

        <div class="charts-row">
            <div style="height: 250px;"><canvas id="chartRev"></canvas></div>
            <div style="background: #fdfdfd; padding: 15px; border-radius: 10px; border: 1px solid #eee">
                <h4 style="margin-bottom: 10px;">Options Externes</h4>
                <button onclick="generatePDF()" class="btn btn-pdf" style="width: 100%; margin-bottom: 10px;"><i class="fas fa-file-pdf"></i> Exporter Historique PDF</button>
                <div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                    <p style="font-size: 0.8rem; color: #777; margin-bottom: 5px;">Restaurer une sauvegarde :</p>
                    <input type="file" id="importFile" onchange="importJSON(event)" style="font-size: 0.7rem;">
                </div>
            </div>
        </div>

        <div class="section">
            <h3>Opérations récentes</h3>
            <div style="overflow-x: auto">
                <table id="table-data">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Montant</th>
                            <th>Mode</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="list"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const PATRON_PHONE = "2250789935129";
    let data = JSON.parse(localStorage.getItem('gaming_v1')) || [];
    let storedPass = localStorage.getItem('gaming_pass');
    let chart1;

    // --- SÉCURITÉ ---
    window.onload = () => {
        if (!storedPass) {
            document.getElementById('auth-title').innerText = "Bienvenue";
            document.getElementById('auth-msg').innerText = "Créez votre code PIN (4 chiffres min)";
        }
    };

    function handleAuth() {
        const input = document.getElementById('password-input').value;
        if (!storedPass) {
            if (input.length < 4) return alert("Le code doit faire au moins 4 chiffres");
            localStorage.setItem('gaming_pass', input);
            storedPass = input;
            alert("Code PIN activé !");
            login();
        } else {
            if (input === storedPass) { login(); } 
            else { alert("Code incorrect !"); document.getElementById('password-input').value = ""; }
        }
    }

    function changePIN() {
        const verify = prompt("Veuillez entrer le code PIN actuel :");
        if (verify === storedPass) {
            const nouveau = prompt("Entrez le nouveau code PIN (4 chiffres min) :");
            if (nouveau && nouveau.length >= 4) {
                localStorage.setItem('gaming_pass', nouveau);
                storedPass = nouveau;
                alert("Modification réussie !");
            }
        } else { alert("Code actuel incorrect !"); }
    }

    function login() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        initCharts();
        refresh();
    }

    function logout() {
        document.getElementById('password-input').value = "";
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('auth-screen').style.display = 'flex';
    }

    // --- SAUVEGARDE EXTERNE (JSON) ---
    function exportJSON() {
        if (data.length === 0) return alert("Rien à sauvegarder !");
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `SAUVEGARDE_GAMING_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
        a.click();
        alert("Fichier de sauvegarde téléchargé. Gardez-le sur votre Google Drive ou envoyez-le par email !");
    }

    function importJSON(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (confirm("Voulez-vous fusionner ces données avec vos comptes actuels ?")) {
                    data = [...imported, ...data];
                    // Supprimer les doublons par ID
                    data = Array.from(new Map(data.map(item => [item.id, item])).values());
                    localStorage.setItem('gaming_v1', JSON.stringify(data));
                    refresh();
                    alert("Données restaurées avec succès !");
                }
            } catch (err) { alert("Fichier invalide."); }
        };
        reader.readAsText(file);
    }

    // --- COMPTABILITÉ ---
    function addEntry() {
        const desc = document.getElementById('desc').value;
        const price = parseFloat(document.getElementById('price').value);
        const type = document.getElementById('type').value;
        const mode = document.getElementById('mode').value;
        if(!desc || !price) return;

        data.unshift({
            id: Date.now(),
            date: new Date().toLocaleDateString('fr-FR'),
            desc, price, type, mode
        });

        localStorage.setItem('gaming_v1', JSON.stringify(data));
        document.getElementById('desc').value = "";
        document.getElementById('price').value = "";
        refresh();
    }

    function deleteEntry(id) {
        if(confirm("Supprimer ?")) {
            data = data.filter(x => x.id !== id);
            localStorage.setItem('gaming_v1', JSON.stringify(data));
            refresh();
        }
    }

    function refresh() {
        const list = document.getElementById('list');
        list.innerHTML = "";
        let total = 0, dRev = 0, dExp = 0;
        const today = new Date().toLocaleDateString('fr-FR');

        data.forEach(item => {
            const isRecette = item.type === 'recette';
            if(isRecette) total += item.price; else total -= item.price;
            if(item.date === today) {
                if(isRecette) dRev += item.price; else dExp += item.price;
            }
            list.innerHTML += `<tr><td>${item.date}</td><td>${item.desc}</td><td style="color:${isRecette?'#27ae60':'#e74c3c'}; font-weight:bold">${item.price.toLocaleString()} F</td><td><small>${item.mode}</small></td><td><button onclick="deleteEntry(${item.id})" class="btn" style="background:#ff4757; padding:5px 8px"><i class="fas fa-trash"></i></button></td></tr>`;
        });

        document.getElementById('total-balance').innerText = total.toLocaleString() + " FCFA";
        document.getElementById('day-rev').innerText = dRev.toLocaleString() + " F";
        document.getElementById('day-exp').innerText = dExp.toLocaleString() + " F";
        document.getElementById('current-date').innerText = today;
        if(chart1) updateCharts(dRev, dExp);
    }

    function sendWhatsApp() {
        const today = new Date().toLocaleDateString('fr-FR');
        const todayData = data.filter(x => x.date === today);
        if(todayData.length === 0) return alert("Pas de données.");
        let totalRev = 0, totalExp = 0;
        let msg = `*POINT GAMING - ${today}*\n\n`;
        todayData.forEach(x => {
            if(x.type === 'recette') { msg += `✅ ${x.desc}: +${x.price}\n`; totalRev += x.price; }
            else { msg += `❌ ${x.desc}: -${x.price}\n`; totalExp += x.price; }
        });
        msg += `\n*NET : ${(totalRev - totalExp).toLocaleString()} FCFA*`;
        window.open(`https://wa.me/${PATRON_PHONE}?text=${encodeURIComponent(msg)}`);
    }

    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("GESTION COMPTA - GAMING CENTER", 14, 20);
        const rows = data.map(x => [x.date, x.desc, x.type, x.price.toLocaleString() + ' F', x.mode]);
        doc.autoTable({ startY: 30, head: [['Date', 'Description', 'Type', 'Montant', 'Mode']], body: rows });
        doc.save(`Bilan_Gaming_${new Date().toLocaleDateString('fr-FR')}.pdf`);
    }

    function initCharts() {
        const ctx = document.getElementById('chartRev').getContext('2d');
        chart1 = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: ['Recettes', 'Dépenses'], datasets: [{ data: [0,0], backgroundColor: ['#27ae60', '#e74c3c'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function updateCharts(rev, exp) {
        chart1.data.datasets[0].data = [rev, exp];
        chart1.update();
    }
</script>
</body>
</html>
